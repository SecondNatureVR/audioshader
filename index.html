<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioShader - Audio Reactive Visualizer</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    <canvas id="canvas"></canvas>

    <!-- Curve Editor Drawer -->
    <div id="curve-editor-drawer" class="curve-editor-drawer">
        <div class="curve-editor-content">
            <div class="curve-editor-header">
                <div class="curve-editor-title" id="curve-editor-title">Curve</div>
                <button class="curve-editor-close" id="curve-editor-close" title="Close">Ã—</button>
            </div>
            
            <!-- Parameter Value Slider (matches other sliders) -->
            <div class="control-group" id="curve-param-slider-container" style="display: none;">
                <label id="curve-param-label"></label>
                <div class="control-row">
                    <input type="range" id="curve-param-slider" min="0" max="100" step="0.01" value="50">
                    <span class="value" id="curve-param-value" contenteditable="true">0.00</span>
                </div>
            </div>
            
            <!-- Compact Curve Canvas -->
            <div class="curve-canvas-container">
                <canvas id="curve-canvas" class="curve-canvas"></canvas>
            </div>
            
            <!-- Compact Controls -->
            <div class="curve-controls">
                <div class="control-group" style="margin-bottom: 6px;">
                    <label style="font-size: 9px;">Min</label>
                    <input type="number" id="curve-min" step="any" value="0" style="width: 100%; padding: 3px 6px; font-size: 9px; background: #0a0a0a; border: 1px solid #333; color: #fff; border-radius: 3px;">
                </div>
                <div class="control-group" style="margin-bottom: 6px;">
                    <label style="font-size: 9px;">Max</label>
                    <input type="number" id="curve-max" step="any" value="1" style="width: 100%; padding: 3px 6px; font-size: 9px; background: #0a0a0a; border: 1px solid #333; color: #fff; border-radius: 3px;">
                </div>
            </div>
            
            <!-- Power Slider (matches other sliders) -->
            <div class="control-group" style="margin-bottom: 6px;">
                <label style="font-size: 9px;">Power</label>
                <div class="control-row">
                    <input type="range" id="curve-power" min="0.1" max="5" step="0.1" value="1.0">
                    <span class="value" id="curve-power-value">1.0</span>
                </div>
            </div>
            
            <!-- Compact Actions -->
            <div class="curve-actions">
                <button class="curve-btn-action" id="curve-reset" style="font-size: 9px; padding: 4px 8px;">Reset</button>
            </div>
        </div>
    </div>

    <!-- Modulation Config Drawer (dynamically populated by UIController) -->
    <div id="modulation-drawer" class="modulation-drawer">
        <div class="modulation-drawer-content" id="modulation-drawer-content">
            <!-- Header, slots, and actions rendered dynamically -->
        </div>
    </div>

    <!-- Load GIF.js library -->
    <script src="vendor/gif.js"></script>

    <!-- Hotkey Legend -->
    <div id="hotkey-legend">
        <h4>Hotkeys</h4>
        <div class="hotkey-item">
            <span class="hotkey-key">Space</span>
            <span class="hotkey-desc">Pause (stop render)</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">F</span>
            <span class="hotkey-desc">Freeze Dilation</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">R</span>
            <span class="hotkey-desc">Randomize</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">&larr; &rarr;</span>
            <span class="hotkey-desc">Cycle Presets</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">J</span>
            <span class="hotkey-desc">Toggle Jiggle</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">Esc</span>
            <span class="hotkey-desc">Clear Screen</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">&uarr;</span>
            <span class="hotkey-desc">Accelerate</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">&darr;</span>
            <span class="hotkey-desc">Decelerate</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">S</span>
            <span class="hotkey-desc">Snapshot (PNG)</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">G</span>
            <span class="hotkey-desc">Record GIF (max 10s)</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">1</span>
            <span class="hotkey-desc">Toggle Interpolation</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">H</span>
            <span class="hotkey-desc">Toggle UI</span>
        </div>
        <div class="hotkey-item">
            <span class="hotkey-key">M</span>
            <span class="hotkey-desc">Audio Mapping Panel</span>
        </div>
    </div>

    <!-- Status Indicators -->
    <div id="status-indicators">
        <span id="pause-indicator" style="display: none; background: #f80; color: #fff;">PAUSE</span>
        <span id="freeze-indicator" style="display: none; background: #0af; color: #fff;">FREEZE</span>
        <span id="jiggle-indicator" style="display: none; background: #a0a; color: #fff;">JIGGLE</span>
        <span id="unsaved-indicator" style="display: none; background: #fa0; color: #fff;">UNSAVED</span>
        <span id="record-indicator" style="display: none; background: #e33; color: #fff;">RECORD</span>
    </div>

    <!-- Dev Toolbox (Main Controls Panel) -->
    <div id="dev-toolbox">
        <h3>AudioShader Controls</h3>

        <!-- Interpolation Settings -->
        <div class="section-header collapsed" id="interpolation-settings-header">
            <span>Interpolation Settings</span>
        </div>
        <div id="interpolation-settings-content" style="display: none; padding-left: 8px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 6px; cursor: pointer;">
                <input type="checkbox" id="interpolation-enabled" checked>
                <span>Enable Interpolation</span>
            </label>
            <div class="control-group">
                <label>Duration (s)</label>
                <div class="control-row">
                    <input type="range" id="interpolation-duration-slider" min="0.1" max="2" step="0.05" value="0.5">
                    <span class="value" id="interpolation-duration-value" contenteditable="true">0.50</span>
                </div>
            </div>
            <div class="control-group">
                <label>Easing</label>
                <select id="interpolation-easing-select" style="width: 100%;">
                    <option value="linear">Linear</option>
                    <option value="easeIn">Ease In</option>
                    <option value="easeOut">Ease Out</option>
                    <option value="easeInOut" selected>Ease In Out</option>
                </select>
            </div>
            <div class="control-group">
                <label>Spring Constant</label>
                <div class="control-row">
                    <input type="range" id="interpolation-spring-slider" min="0.01" max="0.5" step="0.01" value="0.1">
                    <span class="value" id="interpolation-spring-value" contenteditable="true">0.10</span>
                </div>
            </div>
            <div class="control-group">
                <label>Spring Damping</label>
                <div class="control-row">
                    <input type="range" id="interpolation-damping-slider" min="0.5" max="0.99" step="0.01" value="0.8">
                    <span class="value" id="interpolation-damping-value" contenteditable="true">0.80</span>
                </div>
            </div>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-top: 6px; cursor: pointer;">
                <input type="checkbox" id="interpolation-rotation-spring" checked>
                <span>Use Spring for Rotation</span>
            </label>
        </div>

        <!-- Audio Controls -->
        <div class="section-header collapsed" id="audio-controls-header">
            <span>Audio Controls</span>
        </div>
        <div id="audio-controls-content" style="display: none; padding-left: 8px;">
            <div class="control-group">
                <label>Audio Device</label>
                <select id="audio-device-select" style="width: 100%;">
                    <option value="">Default Device</option>
                </select>
            </div>
            <button id="audio-enable-btn" style="width: 100%; padding: 6px; margin-top: 6px; background: #0af; border: none; color: #fff; cursor: pointer; border-radius: 3px;">
                Enable Mic/Device
            </button>
            <button id="audio-tab-btn" style="width: 100%; padding: 6px; margin-top: 6px; background: #a0f; border: none; color: #fff; cursor: pointer; border-radius: 3px;">
                Capture Tab Audio
            </button>
            <div id="audio-status" style="font-size: 9px; color: #888; margin-top: 6px;">Audio: Disabled</div>
        </div>

        <!-- Preset Management -->
        <div class="section-header" style="margin-top: 8px;">
            <span>Presets</span>
        </div>
        <div class="control-group">
            <select id="preset-select" style="width: 100%; margin-bottom: 6px;">
                <option value="">-- Select Preset --</option>
            </select>
            <div style="display: flex; gap: 6px; margin-bottom: 6px;">
                <input type="text" id="preset-name-input" placeholder="New preset name" style="flex: 1; padding: 4px;">
                <button id="save-preset-btn" style="padding: 4px 8px; background: #0af; border: none; color: #000; cursor: pointer; border-radius: 3px;">Save</button>
            </div>
            <div style="display: flex; gap: 6px;">
                <button id="delete-preset-btn" style="flex: 1; padding: 4px; background: #a00; border: none; color: #fff; cursor: pointer; border-radius: 3px;">Delete</button>
                <button id="export-presets-btn" style="flex: 1; padding: 4px; background: #555; border: none; color: #fff; cursor: pointer; border-radius: 3px;">Export</button>
                <label style="flex: 1; padding: 4px; background: #555; color: #fff; text-align: center; cursor: pointer; border-radius: 3px; font-size: 10px;">
                    Import
                    <input type="file" id="import-presets-input" accept=".json" style="display: none;">
                </label>
            </div>
        </div>

        <!-- Resolution -->
        <div class="section-header">
            <span>Resolution</span>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px;">
            <button class="resolution-btn" data-resolution="4k" style="padding: 4px 8px; background: #333; border: 1px solid #555; color: #fff; cursor: pointer; border-radius: 3px; font-size: 9px;">4K</button>
            <button class="resolution-btn" data-resolution="1440p" style="padding: 4px 8px; background: #333; border: 1px solid #555; color: #fff; cursor: pointer; border-radius: 3px; font-size: 9px;">1440p</button>
            <button class="resolution-btn" data-resolution="pc" style="padding: 4px 8px; background: #333; border: 1px solid #555; color: #fff; cursor: pointer; border-radius: 3px; font-size: 9px;">1080p</button>
            <button class="resolution-btn" data-resolution="720p" style="padding: 4px 8px; background: #333; border: 1px solid #555; color: #fff; cursor: pointer; border-radius: 3px; font-size: 9px;">720p</button>
            <button class="resolution-btn active" data-resolution="window" style="padding: 4px 8px; background: #333; border: 1px solid #555; color: #fff; cursor: pointer; border-radius: 3px; font-size: 9px;">Window</button>
        </div>
        <div id="current-resolution-display" style="font-size: 8px; color: #888; margin-bottom: 8px;">Current: Window Size</div>

        <!-- Shape Parameters -->
        <div class="section-header">
            <span>Shape</span>
        </div>
        <!-- Label derived automatically from param-name using centralized PARAM_LABELS -->
        <param-slider
            param-name="spikiness"
            value="0.5"
            min="0"
            max="100"
            step="1"
            format="decimal2"
            show-curve-btn
        ></param-slider>
        <div class="control-group">
            <label>Spike Frequency <span class="curve-btn" data-param="spikeFrequency" title="Edit curve">~</span></label>
            <div class="control-row">
                <input type="range" id="spike-frequency-slider" min="2" max="20" step="0.1" value="5">
                <span class="value" id="spike-frequency-value" contenteditable="true">5.0</span>
            </div>
        </div>
        <div class="control-group">
            <label>Spike Sharpness <span class="curve-btn" data-param="spikeSharpness" title="Edit curve">~</span></label>
            <div class="control-row">
                <input type="range" id="spike-sharpness-slider" min="0" max="100" value="0">
                <span class="value" id="spike-sharpness-value" contenteditable="true">0.00</span>
            </div>
        </div>

        <!-- Appearance Parameters -->
        <div class="section-header">
            <span>Appearance</span>
        </div>
        <div class="two-column">
            <div class="control-group">
                <label>Hue <span class="curve-btn" data-param="hue" title="Edit curve">~</span></label>
                <div class="control-row">
                    <input type="range" id="hue-slider" min="0" max="360" value="180">
                    <span class="value" id="hue-value" contenteditable="true">180&deg;</span>
                </div>
            </div>
            <div class="control-group">
                <label>Scale <span class="curve-btn" data-param="scale" title="Edit curve">~</span></label>
                <div class="control-row">
                    <input type="range" id="scale-slider" min="0.05" max="1" step="0.01" value="0.5">
                    <span class="value" id="scale-value" contenteditable="true">0.50</span>
                </div>
            </div>
        </div>
        <div class="two-column">
            <div class="control-group">
                <label>Fill Size <span class="curve-btn" data-param="fillSize" title="Edit curve">~</span></label>
                <div class="control-row">
                    <input type="range" id="fill-size-slider" min="0" max="100" value="0">
                    <span class="value" id="fill-size-value" contenteditable="true">0.00</span>
                </div>
            </div>
            <div class="control-group">
                <label>Fill Opacity <span class="curve-btn" data-param="fillOpacity" title="Edit curve">~</span></label>
                <div class="control-row">
                    <input type="range" id="fill-opacity-slider" min="0" max="100" value="60">
                    <span class="value" id="fill-opacity-value" contenteditable="true">0.60</span>
                </div>
            </div>
        </div>
        <div class="control-group">
            <label>Blend Mode</label>
            <select id="blend-mode-select" style="width: 100%;">
                <option value="additive" selected>Additive</option>
                <option value="alpha">Alpha</option>
                <option value="multiply">Multiply</option>
                <option value="screen">Screen</option>
                <option value="overlay">Overlay</option>
            </select>
        </div>
        <div class="control-group">
            <label>Blend Opacity <span class="curve-btn" data-param="blendOpacity" title="Edit curve">~</span></label>
            <div class="control-row">
                <input type="range" id="blend-opacity-slider" min="0" max="100" value="100">
                <span class="value" id="blend-opacity-value" contenteditable="true">1.00</span>
            </div>
        </div>

        <!-- Emanation Parameters -->
        <div class="section-header">
            <span>Emanation</span>
        </div>
        <div class="control-group">
            <label>Dilation Speed <span class="curve-btn" data-param="expansionFactor" title="Edit curve">~</span></label>
            <div class="control-row">
                <input type="range" id="expansion-factor-slider" min="0" max="200" value="100">
                <span class="value" id="expansion-factor-value" contenteditable="true">1.0100</span>
            </div>
        </div>
        <div class="control-group">
            <label>Fade Amount <span class="curve-btn" data-param="fadeAmount" title="Edit curve">~</span></label>
            <div class="control-row">
                <input type="range" id="fade-amount-slider" min="0" max="100" value="30">
                <span class="value" id="fade-amount-value" contenteditable="true">0.300</span>
            </div>
        </div>
        <div class="control-group">
            <label>Emanation Rate <span class="curve-btn" data-param="emanationRate" title="Edit curve">~</span></label>
            <div class="control-row">
                <input type="range" id="emanation-rate-slider" min="2" max="200" value="2">
                <span class="value" id="emanation-rate-value" contenteditable="true">2.0</span>
            </div>
        </div>

        <!-- Filter Parameters -->
        <div class="section-header">
            <span>Filters</span>
        </div>
        <div class="two-column">
            <div class="control-group">
                <label>Noise Amount <span class="curve-btn" data-param="noiseAmount" title="Edit curve">~</span></label>
                <div class="control-row">
                    <input type="range" id="noise-amount-slider" min="0" max="100" value="0">
                    <span class="value" id="noise-amount-value" contenteditable="true">0.00</span>
                </div>
            </div>
            <div class="control-group">
                <label>Noise Rate <span class="curve-btn" data-param="noiseRate" title="Edit curve">~</span></label>
                <div class="control-row">
                    <input type="range" id="noise-rate-slider" min="0" max="100" value="0">
                    <span class="value" id="noise-rate-value" contenteditable="true">0.00</span>
                </div>
            </div>
        </div>
        <div class="two-column">
            <div class="control-group">
                <label>Blur Amount <span class="curve-btn" data-param="blurAmount" title="Edit curve">~</span></label>
                <div class="control-row">
                    <input type="range" id="blur-amount-slider" min="0" max="100" value="0">
                    <span class="value" id="blur-amount-value" contenteditable="true">0.00</span>
                </div>
            </div>
            <div class="control-group">
                <label>Blur Rate <span class="curve-btn" data-param="blurRate" title="Edit curve">~</span></label>
                <div class="control-row">
                    <input type="range" id="blur-rate-slider" min="0" max="100" value="0">
                    <span class="value" id="blur-rate-value" contenteditable="true">0.00</span>
                </div>
            </div>
        </div>

        <!-- Rotation Parameters -->
        <div class="section-header">
            <span>Rotation</span>
        </div>
        <div class="two-column">
            <div class="control-group">
                <label>Manual <span class="curve-btn" data-param="rotation" title="Edit curve">~</span></label>
                <div class="control-row">
                    <input type="range" id="rotation-slider" min="0" max="360" value="0">
                    <span class="value" id="rotation-value" contenteditable="true">0&deg;</span>
                </div>
            </div>
            <div class="control-group">
                <label>Auto (deg/s) <span class="curve-btn" data-param="autoRotationSpeed" title="Edit curve">~</span></label>
                <div class="control-row">
                    <input type="range" id="auto-rotation-speed-slider" min="0" max="200" value="50">
                    <span class="value" id="auto-rotation-speed-value" contenteditable="true">15.0&deg;</span>
                </div>
            </div>
        </div>

        <!-- Effects Parameters -->
        <div class="section-header">
            <span>Effects</span>
        </div>
        <div class="control-group">
            <label>Hue Shift Amount <span class="curve-btn" data-param="hueShiftAmount" title="Edit curve">~</span></label>
            <div class="control-row">
                <input type="range" id="hue-shift-amount-slider" min="0" max="100" value="0">
                <span class="value" id="hue-shift-amount-value" contenteditable="true">0.000</span>
            </div>
        </div>

        <!-- Actions -->
        <div class="section-header">
            <span>Actions</span>
        </div>
        <div style="display: flex; gap: 6px; margin-bottom: 8px;">
            <button id="randomize-btn" style="flex: 1; padding: 6px; background: #fa0; border: none; color: #000; cursor: pointer; border-radius: 3px;">Randomize</button>
            <button id="jiggle-btn" style="flex: 1; padding: 6px; background: #a0a; border: none; color: #fff; cursor: pointer; border-radius: 3px;">Jiggle</button>
        </div>
        <div class="control-group">
            <label>Jiggle Amount <span class="curve-btn" data-param="jiggleAmount" title="Edit curve">~</span></label>
            <div class="control-row">
                <input type="range" id="jiggle-amount-slider" min="0" max="100" value="30">
                <span class="value" id="jiggle-amount-value" contenteditable="true">30%</span>
            </div>
        </div>

        <!-- Jiggle Settings (Collapsed by default) -->
        <div class="section-header collapsed" id="jiggle-settings-header" style="margin-top: 8px; margin-bottom: 6px; padding-top: 8px; border-top: 1px solid #333; cursor: pointer;">
            <span>Jiggle Parameter Settings</span>
        </div>
        <div id="jiggle-settings-content" style="display: none; padding-left: 8px;">
            <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                <button id="jiggle-all-btn" style="flex: 1; padding: 4px; background: #0a0; border: none; color: #fff; cursor: pointer; border-radius: 3px; font-size: 8px;">All</button>
                <button id="jiggle-none-btn" style="flex: 1; padding: 4px; background: #a00; border: none; color: #fff; cursor: pointer; border-radius: 3px; font-size: 8px;">None</button>
                <button id="jiggle-shape-btn" style="flex: 1; padding: 4px; background: #555; border: none; color: #fff; cursor: pointer; border-radius: 3px; font-size: 8px;">Shape</button>
                <button id="jiggle-appearance-btn" style="flex: 1; padding: 4px; background: #555; border: none; color: #fff; cursor: pointer; border-radius: 3px; font-size: 8px;">Appear</button>
            </div>

            <div style="font-size: 9px; color: #888; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Shape</div>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-spikiness" checked>
                <span>Spikiness</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-spikeFrequency" checked>
                <span>Spike Frequency</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-spikeSharpness" checked>
                <span>Spike Sharpness</span>
            </label>

            <div style="font-size: 9px; color: #888; margin-top: 8px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Appearance</div>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-hue" checked>
                <span>Hue</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-scale" checked>
                <span>Scale</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-fillSize" checked>
                <span>Fill Size</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-fillOpacity" checked>
                <span>Fill Opacity</span>
            </label>

            <div style="font-size: 9px; color: #888; margin-top: 8px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Emanation</div>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-expansionFactor" checked>
                <span>Dilation Speed</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-fadeAmount" checked>
                <span>Fade Amount</span>
            </label>

            <div style="font-size: 9px; color: #888; margin-top: 8px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Filters</div>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-noiseAmount" checked>
                <span>Noise Amount</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-noiseRate" checked>
                <span>Noise Rate</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-blurAmount" checked>
                <span>Blur Amount</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-blurRate" checked>
                <span>Blur Rate</span>
            </label>

            <div style="font-size: 9px; color: #888; margin-top: 8px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Rotation</div>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-autoRotationSpeed" checked>
                <span>Auto Rotation</span>
            </label>

            <div style="font-size: 9px; color: #888; margin-top: 8px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Effects</div>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-hueShiftAmount" checked>
                <span>Hue Shift</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 9px; margin-bottom: 4px; cursor: pointer;">
                <input type="checkbox" id="jiggle-param-blendOpacity" checked>
                <span>Blend Opacity</span>
            </label>
        </div>

        <!-- Debug Values (Collapsed by default) -->
        <div class="section-header collapsed" id="debug-values-header" style="margin-top: 8px; margin-bottom: 6px; padding-top: 8px; border-top: 1px solid #333; cursor: pointer;">
            <span>Debug Values</span>
        </div>
        <div id="debug-values-content" style="display: none; padding-left: 8px;">
            <div id="debug-output" style="font-size: 8px; font-family: monospace; color: #aaa; line-height: 1.4; max-height: 400px; overflow-y: auto; background: #1a1a1a; padding: 6px; border-radius: 3px; border: 1px solid #333; white-space: pre-wrap;">
                <!-- Debug values will be populated here -->
            </div>
        </div>
    </div>

    <!-- Audio Mapping Panel (Hidden by default, toggle with M key) -->
    <div id="audio-mapping-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h4 style="margin: 0;">Audio Mapping</h4>
            <div style="display: flex; gap: 4px;">
                <button id="randomize-mappings-btn" class="curve-btn-action" style="font-size: 8px; padding: 3px 6px; opacity: 0.6;" title="Randomize which metrics map to which params">Rnd Map</button>
                <button id="randomize-values-btn" class="curve-btn-action" style="font-size: 8px; padding: 3px 6px; opacity: 0.6;" title="Randomize modulation values (keep current sources)">Rnd Val</button>
            </div>
        </div>

        <!-- Audio Reactive Toggle -->
        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px;">
            <input type="checkbox" id="audio-reactive-enabled" checked style="cursor: pointer;">
            <label for="audio-reactive-enabled" style="font-size: 10px; color: #bbb; cursor: pointer; margin: 0;">Audio Reactive Mode</label>
        </div>

        <!-- Audio Radar Chart -->
        <div style="text-align: center; margin-bottom: 10px;">
            <canvas id="audio-radar-canvas" width="200" height="200" style="display: block; margin: 0 auto; background: rgba(0,0,0,0.3); border-radius: 4px;"></canvas>
        </div>

        <!-- Active Routes (replaces old parameter mapping list) -->
        <div id="active-routes-section">
            <div class="mod-section-toggle" id="routes-section-toggle">
                <h5 style="margin:0;">Active Routes <span id="active-routes-count" style="color:#555;">(0)</span></h5>
            </div>
            <div id="active-routes-container" style="font-size: 9px;">
                <!-- Populated dynamically by updateActiveMappingsOverview -->
            </div>
            <button type="button" id="mod-add-route-btn" class="curve-btn-action" style="font-size:8px;padding:3px 8px;margin-top:4px;">+ Add Route</button>
            <div id="mod-add-route-form" class="mod-add-route-form" style="display:none;">
                <select id="add-route-source" title="Audio source">
                    <!-- populated dynamically -->
                </select>
                <span style="color:#555;font-size:9px;">&rarr;</span>
                <select id="add-route-target" title="Visual parameter">
                    <!-- populated dynamically -->
                </select>
                <button type="button" id="add-route-confirm" class="curve-btn-action" style="font-size:8px;padding:2px 6px;">Add</button>
                <button type="button" id="add-route-cancel" class="curve-btn-action" style="font-size:8px;padding:2px 6px;">Cancel</button>
            </div>
        </div>

        <!-- Audio Metrics (collapsible, collapsed by default) -->
        <div id="audio-metrics-section" style="margin-top: 10px;">
            <div class="mod-section-toggle" id="metrics-section-toggle">
                <h5 style="margin:0;">Audio Metrics</h5>
                <span class="mod-section-arrow collapsed" id="metrics-section-arrow">&#9660;</span>
            </div>
            <div id="audio-metrics-collapsible" style="display:none;">
                <table class="metrics-table" id="audio-metrics-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                            <th>Range</th>
                            <th>Bar</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-metric="rms"><td class="metric-name">RMS</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="bass"><td class="metric-name">Bass</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="mid"><td class="metric-name">Mid</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="high"><td class="metric-name">High</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="presence"><td class="metric-name">Presence</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="harshness"><td class="metric-name">Harshness</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="mud"><td class="metric-name">Mud</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="compression"><td class="metric-name">Compression</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="collision"><td class="metric-name">Collision</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="coherence"><td class="metric-name">Coherence</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="stereoWidth"><td class="metric-name">Stereo Width</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="phaseRisk"><td class="metric-name">Phase Risk</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="lowImbalance"><td class="metric-name">Low Imbalance</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="emptiness"><td class="metric-name">Emptiness</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                        <tr data-metric="panPosition"><td class="metric-name">Pan Position</td><td class="metric-value">0.000</td><td class="metric-range">0-1</td><td><div class="metric-bar-container"><div class="metric-bar-range"></div><div class="metric-bar-current"></div></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Load TypeScript modules via Vite -->
    <script type="module" src="/src/main.ts"></script>
</body>
</html>
